### Volcano 数据库查询评估系统

- 文件系统层

  1. 基本抽象和操作
  2. 机制 和 策略 分离 : 提供访问这些对象的机制, 

- 查询处理层

  1. 所有的 操作符 被实现为 iterator, 

  2. iterator 本身包括初始化，增量，循环终止条件

  3. 每个迭代器都一个状态记录 (state record), 一个迭代器提供 arguments , input  , state 等接口.

  4. 对于数据对象的操作和解释，例如比较和哈希，通过 support function 函数指针传递给迭代器.

  5. 每个迭代器 都支持 3 个函数

     1. Open 函数, 最顶层算子调用, 实例化该算子关联的状态记录. 例如 hashtable 的创建.

        Open 函数内部会调用该算子孩子的 Open 函数. 这样，所有的迭代器以递归的方式启动.

     2. Next 函数，为了执行查询，我们重复调用最顶层的算子的 Next 函数, 一直到它失败并显示流结束指示符.

     3. 顶层算子 如果需要更多的输入来产生输出数据，它会调用孩子的 Next 函数.

     4. Close 函数，递归的关闭所有的迭代器, 包括资源的销毁等. 

- 该系统实现的元操作符 choose - Plan

  1. 背景

     传统优化器基于一些假设, 预测生成了查询计划. 最优性取决于假设的有效性. 如果一个查询计划在很长一段时间内重复使用, 何时重新优化是很有必要的.

  2. 实现

     choose - plan 操作符

     不是传统意义的操作符，因为它不做任何数据操作. 我们称为元运算符.

     该运算符支持 open -> next -> close 协议, 因此可以插入到查询计划的任意位置. 

     open 函数决定了使用多个等效查询计划的哪一个. 决定策略是由对应的支持函数所实现的.

     next, close 函数只是简单的调用 子 操作符 对应的 next, close 函数.

  3. 总结

     不影响其他运算符, 使用非常灵活.

     机制与策略分离原则的体现 : chose - plan 操作符是机制, 对应多个选择策略，每个策略通过支持函数来实现.

- 多处理器查询评估

  1. 思路

     把所有并行相关的处理都集中在一个运算符中.

  2. 实现

     exchange 运算符

     不是传统意义上的操作符，因为它不做任何数据操作. 我们称为元运算符.

     该运算符支持 open -> next -> close 协议，因此可以插入到查询计划的任意位置.

     exchange 操作符实现了垂直并行和水平并行.

- 垂直并行

  1. 垂直并行可以理解为算子之间并行
  2. 如右图, 原来在每一个进程内执行的 plan, 现在分为 5 个进程执行. 每个进程执行 plan 的一部分.
  3. Open 函数, 创建一个新的进程. 创建一个共享内存结构体: port , Port 是用来做同步 和 数据交换.
  4. 原进程叫做消费者, 新进程叫做生产者.
  5. 消费者中的 exchange 算子就是一个普通的迭代器, 唯一不同的是这个算子的 input 是通过进程间通信得到的.
  6. Next 函数, 等待数据的到来并返回.
  7. 生产中的 exchange 算子 : 作为生产者 plan 的驱动. Next 函数的输出放到 port 内.

- 水平并行

  1. 水平并行分为两种 : Bushy parallelism; intra-operator parallelism

  2. Bushy parallelism 与垂直并行类似，都是算子间并行 : inter-operator parallelism. 只是 Bushy

  3. 区别 :

     inter - operator parallelism : 每个进程执行不同的 operator.

     intra - operator parallelism : 多个进程执行同一个 operator. 需要数据分区, 每个进程处理不同的分区数据.