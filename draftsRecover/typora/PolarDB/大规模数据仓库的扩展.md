### Online Expansion of Large-scale Data Warehouses

- 大规模数据仓库的在线扩展
  - 这里我认为这里所说的数据仓库泛指 多机数据库
- 在大型企业的数据分析往往是局限的，经过仔细优先排序的来源。但随着产品迭代，数据库也需要扩展，那么在线扩展有时候就成为了一个很好的点。
  - 如果业务允许的情况下，当然离线扩展是最好的方法。
  - 但大多数业务都是不被允许的，例如 微信。
  - 分布式哈希表是专门为单个存储主机的灵活组成员资格而设计的数据结构。
  - 他们可以即时分配 / 重新分配数据，并允许相当无缝地添加和删除主机。
- 在本文中提出的扩展机制是相当普遍的。适用于各种基于 MPP 无共享架构。

---

该系统区分两种类型的主机 : 

- Master 主机

  - Master 主机接受传入的连接，并在优化语句或处理后，将一个并行的查询计划发送到 段数据库 进行处理

- 分段 主机

  - 每个分段主机持有一个或多个分段数据库.

  Greenplum 数据库管理两种类型的分段数据库.

  - 主数据库 和 镜像数据库
    - 镜像是主数据库的一个逻辑副本.
    - 镜像和主数据以可配置的模式放置在段主机上。
    - 默认情况下, 每个分段主机将持有 N 个主数据和 N 个镜像。
      - 镜像只在主服务器停机后用于读取查询, 在这种情况下，他们被升级成为代理主服务器。
      - 此外，镜像只是以同步的方式复制主站的写活动

  数据分布

  - 除了目录表位于主数据库中，所有的数据都分布在各段.
  - Greenplum 数据库提供了几种将数据分配给分部的模式。
    - 最突出的是通过对每个表的指定分布列 进行 散列分配。
    - 使用一个或多个列来确定数据的分布
    - 此外除了数据的哈希分割，Greenplum Da-tabase 还提供了一种特殊类型的分布，标记为 RANDOMLY。
      - 如果一个表只有非常少的独立行，这种类型的分布就特别有用。
      - 在这种情况下，散列法将只把数据分配给少量的分段。

  查询处理

  - 只查 Master :
    - 这些查询只涉及位于主站的数据, 例如，目录表，或者可以在主站进行的表达式。该请求不需要将请求发到分段数据库上。
  - 对称分配的查询 :
    - 所有段都执行对称的查询计划，即每个段都执行相同的操作集即使在不同的数据上。一个查询计划可能包含在段之间的分配的操作，包含将所有的数据集中在一个段的情况。以及将所有数据从一个段重新分配到所有其他段。
  - 有针对性的调度查询
    - 所有与查询有关的数据都位于一个段数据库中。
    - 查询计划只被派发到一个单一的段数据库，而不是所有的段数据库中。

  

  ![2022-06-12_19-06-1655033877](/home/fan/Screenshots/2022-06-12_19-06-1655033877.jpg)

  

  这种查询的分类与表的分布密切相关。每个表的分布都被记录在目录中。并在编译时为查询优化器所知。基于这些知识。优化器编译一个查询计划，考虑到数据的位置。像连接或聚合这样的操作需要特定的数据分布，以保证正确的重新结果。

  - 重新分配 N : N 输入的关系根据一祖列的值被重新分配。这种类型的分配操作符通常用于重新分配关系，以便为等价连接或行的分组而将他们放到一起。
  - 收集 N : 1 : 所有的数据被发送到一个单一的段数据库，这种类型的分配运算符通常放在计划的根部，以便将所有的数据集中到主段 ; 他也可以在执行不能在不同段数据库上并行执行的操作之前，在计划中间使用。
  - 广播 1 : N : 输入的关系被发送到所有其他分段数据库。这个操作的常见用例是除等价连接外的连接谓词，其中一个关系分布在某些列上，另一个是复制的。

  所有的分段数据库都执行相同的操作计划并且通过分配操作改变数据来作为处理的一部分。将分配的逻辑封装成自包含的运算符，可以对查询计划进行简洁的推理。数据交换是流水线式的，也就是说，只要有数据就会被改变。

  对于订单表是随机分布的情况。为了达到正确的连接结果，需要对表进行适当的对奇，即订单的所有数据都需要重新分布在 你的查询条件上。

  这个例子强调，查询计划弥补了数据分布的不正确或不充分。

  容错和复制

  - 由于在扩展过程中保持容错性是生产系统的一个关键要求，
  - Greenplum 主站运行一个故障检测算法，定期检查所有的网段的健康状况。如果检测到故障，系统就会重新配置，将用于故障主网的流量相应地传送到其镜像。通过包括 SNMP 在内的警报机制以及在线检测工具，管理员可以对故障主站进行故障排除，在解决了故障的根本原因后，可以使用系统方提供的工具开始恢复，并将恢复后的主站重新整合到系统中
  - 与故障检测系统的交互是与查询处理正交的，没有一个组件知道他们的副本。在扩展过程中，保持同样的容错保证是绝对必要的。

  扩展

  - 最初用 '空' 段主机扩展系统，然后随着时间的推移，将总数据集的小量级从原来的分配中重新分配到整个扩展系统的段数据库中，直到所有的数据都会被重新分配。
  - 重新分配的过程影响不大，在常规查询工作负载运行时在后台发生。
  - 整个扩展过程是由一个名为 gpexpand 的工具协调的，该工具使用 Greenplum 数据库的文档化 API, 具体来说，该工具有三个主要阶段来帮助管理员
    - 1. 初始化，在新的网段主机被物理地添加到现有的集群中，新的系统被初始化，
      2. 重新分配，gpexpand 管理这个过程，并允许管理员在一个相当详细的水平上优先考虑，监控，暂停和/恢复的分配过程，以确保扩展是在后台形成的，不影响正常的用户工作负载。
      3. 最终确定 : 一旦数据的实际重新分配完成，用于调度和优先化的辅助表就会被删除

  配置和初始化

  - 配置 :
    - 这一阶段最大的挑战是扩展系统的技术构建 : 需要克服的障碍包括机架空间方面的限制，布线问题等。一旦完全组装完毕，新的服务器将使用产品套件提供的压力测试工具进行烧录。在这一点上。Greenplum 数据库还配备了一些检查工具，可以检查安装情况，检测性能异常，并检查底层操作系统的正确配置.
  - 初始化
    - 随着新服务器的到位，下一步是安装数据库软件和初始化新的分段主机. 这一步由 gpexpand 提供便利，管理员会被引导通过一个交互式的访谈过程，以确定额外分段主机的主机名以及主服务器和镜像服务器的布局。另外，还可以使用特殊的配置文件来配置扩展，如果扩展涉及到几台机器，并且交互式配置可能容易出错，那么就无用

  建立分销政策

  - 一旦系统重新投入使用，为数据加载而创建的新表就会立即利用新的分段数据库。
  - 数据滚落，大多数数据仓库应用程序使用事实表的日常分区来加载数据。
  - 这意味着对于扩展后的系统，新的数据将在扩展后的系统中使用原始表的分布策略进行最佳分布。随着旧的数据在接下来几天和几周内被推出。数据分布会自动收敛到原来的设计 : 所有新的表都被正确分布，旧的表被陆续删除。在许多应用场景中，由于数据滚动而进行的重新调整是足够的。然而，某些表没有被分割，也不受一个小的保留窗口的限制。例如，尺寸表。这些表需要被重新分配到所有的数据库中，重新建立原来的分配策略，以达到预期的性能。
  - 重新分配
    - 为了重新分配数据，我们需要一个简单而稳健的基元，最好是具有普遍意义的基元，他允许我们一次将单个表重新分配到所需的分配策略。
  - 查询处理
    - 为了实现在线或接近在线的扩展，必须立即恢复正常的查询处理。根据扩展时数据库中存储的数据量，等待所有数据重新分配通常不是一个选项
    - 对分配策略的修改并不影响查询优化器创建有效查询计划的能力。虽然，不同的分布策略的计划在性能上可能有很大的不同，我们之前已经说明了。这意味着不需要对优化器或执行器进行特定的扩展变化。
    - 相反，对具有修改和分配策略的表的查询处理是完全透明的，他的性能特征是直截了当的，而且很容易理解，这有利于故障排除。

  - 安排工作
    - 在扩展过程中，查询性能会下降，因为
      - 1) 表没有得到最佳的分布
        2) 系统带宽被用来重新分配数据, 

  