### Redis 的过期键删除策略

- Redis 使用的是 惰性删除 + 定期删除 两种策略。

  - 完全使用定时删除，是对内存友好的，但是每次定期删除，CPU都会浪费大量时间在删除过期键上。而且 Redis 是单线程的。这无疑会带来巨大的延迟。

  - 完全使用惰性删除，是对 CPU 友好的，每当服务器需要取出键时才会对键进行过期检查。但如果有大量的键值对没有使用到，但我们却访问到，此时就会占用大量的内存。

  - 总结 ：定时删除浪费 太多 CPU 资源。

    ​			惰性删除浪费 太多 内存资源。

    定期删除 ：是对上述两种删除方式的一种折中方式。

    ​			定期删除策略每隔一段时间执行一次删除过期键操作，并通过限制删除操作执行的时长和频率来减少删除操作 对 CPU 时间的影响。

    ​		缺点 ：如果删除操作执行得太频繁，或者执行的时间太长，定期删除策略就会退化成定时删除策略。

    ​					如果删除操作执行得太少，或者执行的时间太短，定期删除策略又会和惰性删除一样。

- 惰性删除 在 /db.c / expireIfNeeded() 该函数中。

  - 当我们使用 SET, LRANGE, SADD, HGET, KEYS 等。会先调用 expirelfNeeded() 来判断该键是否过期。过期则删除。并返回空。键不存在也返回空。

    ```c
    ```

- 定期删除策略在 redis.c / activeExpireCycle 函数实现。每当 Redis 的服务器周期性的操作 redis.c / serverCron 函数执行时，activeExpireCycle 函数就会被调用。