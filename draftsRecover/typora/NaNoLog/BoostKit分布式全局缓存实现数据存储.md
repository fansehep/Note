### BoostKit 分布式全局缓存实现数据存储的极致体验

本赛题需要使用 Global Cache 来对 Ceph 集群进行加速. 传统的 Ceph 集群是一个去中心化的分布式文件系统, Ceph 支持块存储, 对象存储, 文件存储, 底层存储使用对象存储, 文件系统存储 和 块存储基于对象存储模拟, Ceph 使用 Crush 算法通过分布式一致性哈希来算出数据的具体盘, Ceph 使用的是强一致性协议, 所以在 IO 比较大的时候, 它的时延会比较高, 所以这里通过 使用 Global Cache 来对其进行加速.

Global Cache 是一个全局分布式缓存数据库, 他是一个 key / value 缓存数据库, 由于它的数据全部存储在内存中, 所以它的数据是会丢失的, 在没有使用持久化内存的情况下, 目前只能当作缓存使用.  

![2022-07-14_09-07-1657762962](/home/fan/Screenshots/2022-07-14_09-07-1657762962.jpg)

Global Cache 拥有 前后台分离, IO 聚合 智能预取 软硬件协同 垃圾回收 GC 智能淘汰 等等技术.

- 前后台分离, 使用 多 EventLoop 来监听客户端请求, 并用同一个后端来进行处理, 在解决了高度耦合的同时,  还增加了性能.
- IO 聚合, 我们知道目前主流计算机无论是硬盘, CPU , 内存 都有缓存机制, 比如说 我们对磁盘进行多次 write , 那么显然这样是很耗时的, 所以Global Caceh 使用  IO 聚合技术, 将多次的小文件写入聚合在一起写入, 大幅度提高写的性能.
- 智能预取 :
- 软硬件协同 :
- 垃圾回收 :
- 智能淘汰 :

![2022-07-14_09-07-1657763381](/home/fan/Screenshots/2022-07-14_09-07-1657763381.jpg)

方案 :

![2022-07-14_09-07-1657763467](/home/fan/Screenshots/2022-07-14_09-07-1657763467.jpg)

![2022-07-14_09-07-1657763524](/home/fan/Screenshots/2022-07-14_09-07-1657763524.jpg)

在 ceph 单个节点之上 运行一个 Global Cache 缓存系统 , 在单个客户端运行一个 Clobal Cache Client.

当有请求给到 底层的分布式存储时, 首先需要先给到 Global Cache, 

- 1. 如果 Global Cache 有对应的数据时候, 那么便直接返回给到上层的 客户端.
  2. 如果没有的话, 下层应用会从底层的 chunkserver 拿到数据. 然后返回给 Global Cache . Global Cache 做出缓存之后, 在返回给上层应用.

其次我们还须要使用 Global Cache IO 聚合功能, 我们需要 持久化数据到硬盘中, 来保存缓存不会丢失. 最大化 利用 磁盘 IO 功能.

其次我们还需要保证 缓存 和 底层数据的一致性问题.

- 例如 ; 当其他的节点读了一次底层的分布式文件系统的存储, 但此时其他的节点又写了一次底层的分布式文件系统的存储, 那么此时 Globa Cache 的数据 和 底层的分布式文件系统的数据就会产生不一致问题. 
- 解决方案 :
  - 在 Ceph 集群中的 chunkserver 中维护一个变动的日志记录 ChangeLog ,  当每次有更改请求打到底层的存储中, ChangeLog 会记录这一次变动, 并且他会记录上层应用的缓存情况, 当ChangeLog 记录到有底层的分布式文件系统有数据真正的变化, 那么他会通知Global Cache, 让 Global Cache 对应的数据失效 并且丢失. 这样当其他的客户端再次读数据的时候, 就可以 让 Global Cache 重新缓存数据.

我们还可以利用 Global Cache 的 智能预取 和 智能淘汰的功能, 让GLobal Cache 更加

